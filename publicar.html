<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publicar - BLIP</title>
    <style>
        :root { --accent: #7b2cbf; --bg: #050010; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        nav { width: 100%; background: #0a0020; padding: 15px 25px; border-bottom: 1px solid rgba(123, 44, 191, 0.4); box-sizing: border-box; }
        .nav-logo { font-weight: 900; font-size: 24px; cursor: pointer; text-shadow: 0 0 10px var(--accent); color: white; text-decoration: none; }
        .box { background: rgba(255,255,255,0.05); padding: 30px; border-radius: 25px; border: 1px solid rgba(123, 44, 191, 0.3); width: 90%; max-width: 450px; margin-top: 40px; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px; border: 1px solid rgba(123, 44, 191, 0.3); background: #000; color: white; outline: none; box-sizing: border-box; }
        .btn { width: 100%; background: var(--accent); color: white; border: none; padding: 15px; border-radius: 25px; font-weight: bold; cursor: pointer; }
        .preview { width: 100%; height: 250px; border: 2px dashed rgba(123, 44, 191, 0.3); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; overflow: hidden; background: #000; }
        .preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body>
    <nav><a href="index.html" class="nav-logo">BLIP</a></nav>
    <div class="box">
        <h2>NUEVA OBRA</h2>
        <div class="preview" id="previa"><span>Vista previa</span></div>
        <input type="file" id="archivo" accept="image/*">
        <textarea id="desc" placeholder="¿De qué trata? Usa @ para etiquetar artistas y # para hashtags" rows="5"></textarea>
        <button class="btn" id="subir">PUBLICAR AHORA</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
        import { getDatabase, ref, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA5yh8J7Mgij3iZCOEZ2N8r1yhDkLcXsTg",
            authDomain: "almacenamiento-redsocial.firebaseapp.com",
            databaseURL: "https://almacenamiento-redsocial-default-rtdb.firebaseio.com",
            projectId: "almacenamiento-redsocial"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let userActual = null;

        onAuthStateChanged(auth, user => { if(!user) location.href='index.html'; userActual = user; });

        document.getElementById('archivo').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => { document.getElementById('previa').innerHTML = `<img src="${ev.target.result}">`; };
            reader.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('subir').onclick = async () => {
            const file = document.getElementById('archivo').files[0];
            const btn = document.getElementById('subir');
            if(!file) return alert("Sube una imagen");
            btn.disabled = true; btn.innerText = "SUBIENDO...";

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'blip_unsigned');

            try {
                const res = await fetch('https://api.cloudinary.com/v1_1/dz9s37bk0/image/upload', { method: 'POST', body: formData });
                const data = await res.json();
                await push(ref(db, 'posts'), {
                    url: data.secure_url,
                    desc: document.getElementById('desc').value,
                    userName: userActual.displayName,
                    userPic: userActual.photoURL,
                    uid: userActual.uid,
                    timestamp: serverTimestamp()
                });
                location.href = 'index.html';
            } catch (e) { alert("Error"); btn.disabled = false; }
        };
    </script>
</body>
</html>
