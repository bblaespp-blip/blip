<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>BLIP - Sistema Integral</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: { extend: { colors: { "primary": "#7b2cbf", "accent": "#ff0055", "background-dark": "#050010" } } }
        }
    </script>
    <style>
        body { background-color: #050010; color: white; font-family: 'Spline Sans', sans-serif; overflow: hidden; height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(123, 44, 191, 0.2); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #7b2cbf; border-radius: 10px; }
        .active-tab { background: rgba(123, 44, 191, 0.2); color: #7b2cbf; border-radius: 1.5rem; font-weight: bold; }
        section { height: calc(100vh - 80px); overflow-y: auto; padding-bottom: 100px; }
        .hashtag-link { color: #ff0055; font-weight: bold; text-shadow: 0 0 8px rgba(255, 0, 85, 0.3); }
        .mention-link { color: #7b2cbf; font-weight: bold; }
        .fill-1 { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>
<body class="custom-scrollbar">

    <nav class="sticky top-0 z-50 w-full border-b border-primary/30 bg-background-dark/80 backdrop-blur-md h-[70px] flex items-center">
        <div class="max-w-7xl mx-auto w-full px-6 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
                <span class="material-symbols-outlined text-primary text-4xl font-bold">bolt</span>
                <span class="text-2xl font-black italic tracking-tighter uppercase">BLIP</span>
            </div>
            <div class="flex items-center gap-5">
                <div id="auth-section">
                    <button id="btn-login" class="bg-primary px-6 py-2 rounded-full font-bold text-sm">CONECTAR</button>
                </div>
                <div id="user-ui" class="hidden flex items-center gap-5">
                    <button id="btn-logout" class="text-[10px] text-slate-500 hover:text-accent font-bold uppercase tracking-widest transition-colors">Salir</button>
                    <img id="my-avatar" src="" class="w-10 h-10 rounded-full border-2 border-primary cursor-pointer" onclick="irMiPerfil()">
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-[240px_1fr_300px] gap-8 p-6">
        <aside class="hidden lg:flex flex-col gap-4">
            <div class="glass rounded-[2rem] p-5 space-y-2">
                <button onclick="showTab('feed')" id="tab-feed" class="w-full flex items-center gap-4 p-3 active-tab transition-all"><span class="material-symbols-outlined">home</span> Inicio</button>
                <button onclick="showTab('explorar')" id="tab-explorar" class="w-full flex items-center gap-4 p-3 hover:bg-white/5 rounded-2xl transition-all"><span class="material-symbols-outlined">explore</span> Explorar</button>
                <button onclick="showTab('mensajes')" id="tab-mensajes" class="w-full flex items-center gap-4 p-3 hover:bg-white/5 rounded-2xl transition-all"><span class="material-symbols-outlined">chat_bubble</span> Mensajes</button>
                <button onclick="irMiPerfil()" class="w-full flex items-center gap-4 p-3 hover:bg-white/5 rounded-2xl transition-all"><span class="material-symbols-outlined">person</span> Perfil</button>
            </div>
        </aside>

        <div class="flex flex-col">
            <section id="sec-feed" class="flex flex-col gap-6 custom-scrollbar">
                <div class="glass rounded-[2.5rem] p-6 shadow-xl">
                    <div class="flex gap-4">
                        <img id="post-avatar" src="" class="w-12 h-12 rounded-2xl bg-primary/10 border border-white/10">
                        <textarea id="post-text" class="w-full bg-transparent border-none focus:ring-0 text-lg resize-none" placeholder="¿Qué estás creando?" rows="2"></textarea>
                    </div>
                    <div id="preview-box" class="hidden mt-4"><img id="img-preview" class="rounded-3xl w-full max-h-80 object-cover border border-primary/20"></div>
                    <div class="flex justify-between items-center mt-6 pt-4 border-t border-white/5">
                        <label class="cursor-pointer text-primary hover:text-white transition-all">
                            <span class="material-symbols-outlined text-3xl">image</span>
                            <input type="file" id="file-input" class="hidden" accept="image/*">
                        </label>
                        <button id="btn-post" class="bg-primary px-10 py-3 rounded-2xl font-black text-sm tracking-widest shadow-lg shadow-primary/40">BLIP!</button>
                    </div>
                </div>
                <div id="feed-container" class="flex flex-col gap-6"></div>
            </section>

            <section id="sec-explorar" class="hidden custom-scrollbar">
                <div id="explorar-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
            </section>

            <section id="sec-mensajes" class="hidden flex glass rounded-[2.5rem] overflow-hidden h-[75vh]">
                <div class="w-1/3 border-r border-white/10 p-4 bg-black/20 overflow-y-auto custom-scrollbar">
                    <h3 class="text-[10px] font-bold uppercase text-primary mb-4 px-2 tracking-widest">Mis Contactos</h3>
                    <div id="lista-contactos" class="space-y-2"></div>
                </div>
                <div class="w-2/3 flex flex-col bg-black/10">
                    <div id="chat-header" class="p-4 border-b border-white/10 text-sm font-bold flex items-center gap-3">
                        <span class="text-slate-500 italic text-xs">Selecciona un chat</span>
                    </div>
                    <div id="chat-mensajes" class="flex-1 p-4 overflow-y-auto flex flex-col gap-3 custom-scrollbar"></div>
                    <div class="p-4 border-t border-white/10 flex gap-2">
                        <input id="chat-input" type="text" class="flex-1 bg-transparent border-none focus:ring-0 text-sm" placeholder="Escribe un mensaje...">
                        <button id="btn-send-chat" class="bg-primary p-3 rounded-xl flex items-center justify-center"><span class="material-symbols-outlined">send</span></button>
                    </div>
                </div>
            </section>
        </div>

        <aside class="hidden lg:flex flex-col gap-6">
            <div class="glass rounded-[2rem] p-6">
                <h3 class="text-xs font-bold text-primary mb-4 uppercase tracking-widest">En Línea</h3>
                <div id="online-list" class="space-y-4"></div>
            </div>
        </aside>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
        import { getDatabase, ref, push, onValue, serverTimestamp, query, limitToLast, set, remove, onDisconnect, get } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA5yh8J7Mgij3iZCOEZ2N8r1yhDkLcXsTg",
            authDomain: "almacenamiento-redsocial.firebaseapp.com",
            databaseURL: "https://almacenamiento-redsocial-default-rtdb.firebaseio.com",
            projectId: "almacenamiento-redsocial"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();
        let userActual = null;
        let chatDestinoUid = null;
        let selectedFile = null;

        function procesarTexto(texto) {
            if (!texto) return "";
            return texto.replace(/@(\w+)/g, '<span class="mention-link">@$1</span>').replace(/#(\w+)/g, '<span class="hashtag-link">#$1</span>');
        }

        // --- AUTHENTICATION ---
        document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userActual = user;
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('user-ui').classList.remove('hidden');
                document.getElementById('my-avatar').src = user.photoURL;
                document.getElementById('post-avatar').src = user.photoURL;
                
                set(ref(db, `online_users/${user.uid}`), { n: user.displayName, p: user.photoURL });
                onDisconnect(ref(db, `online_users/${user.uid}`)).remove();
                
                escucharFeed(); 
                escucharOnline();

                const abrirChatUid = localStorage.getItem('abrirChatCon');
                if (abrirChatUid) {
                    const nombre = localStorage.getItem('nombreChatCon');
                    const foto = localStorage.getItem('fotoChatCon');
                    showTab('mensajes');
                    window.abrirChat(abrirChatUid, nombre, foto);
                    localStorage.removeItem('abrirChatCon');
                    localStorage.removeItem('nombreChatCon');
                    localStorage.removeItem('fotoChatCon');
                }
            }
        });

        // --- POSTING ---
        document.getElementById('file-input').onchange = (e) => {
            selectedFile = e.target.files[0];
            if(selectedFile) {
                const reader = new FileReader();
                reader.onload = (f) => {
                    document.getElementById('img-preview').src = f.target.result;
                    document.getElementById('preview-box').classList.remove('hidden');
                };
                reader.readAsDataURL(selectedFile);
            }
        };

        document.getElementById('btn-post').onclick = async () => {
            const text = document.getElementById('post-text').value.trim();
            if(!userActual || (!text && !selectedFile)) return;
            const btn = document.getElementById('btn-post');
            btn.disabled = true; btn.innerText = "...";

            let finalUrl = "";
            if(selectedFile) {
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('upload_preset', 'blip_unsigned');
                const res = await fetch('https://api.cloudinary.com/v1_1/dz9s37bk0/image/upload', { method: 'POST', body: formData });
                const data = await res.json();
                finalUrl = data.secure_url;
            }

            await push(ref(db, 'posts'), {
                uid: userActual.uid,
                uName: userActual.displayName,
                uPic: userActual.photoURL,
                content: text,
                image: finalUrl,
                timestamp: serverTimestamp()
            });

            document.getElementById('post-text').value = "";
            document.getElementById('preview-box').classList.add('hidden');
            selectedFile = null;
            btn.disabled = false; btn.innerText = "BLIP!";
        };

        // --- FEED ---
        async function escucharFeed() {
            if (!userActual) return;
            const siguiendoRef = ref(db, 'seguidores');
            const snapSeg = await get(siguiendoRef);
            const misSeguidos = [userActual.uid]; 
            snapSeg.forEach(p => { if (p.hasChild(userActual.uid)) misSeguidos.push(p.key); });

            onValue(query(ref(db, 'posts'), limitToLast(40)), (snap) => {
                const container = document.getElementById('feed-container');
                container.innerHTML = "";
                let posts = [];
                snap.forEach(c => {
                    if (misSeguidos.includes(c.val().uid)) {
                        posts.unshift({id: c.key, ...c.val()});
                    }
                });
                posts.forEach(p => {
                    const lCount = p.likes ? Object.keys(p.likes).length : 0;
                    const hasLike = p.likes && p.likes[userActual.uid];
                    container.innerHTML += `
                        <div class="glass rounded-[2.5rem] p-6">
                            <div class="flex items-center gap-3 mb-4 cursor-pointer" onclick="window.location.href='perfil.html?uid=${p.uid}'">
                                <img src="${p.uPic}" class="w-10 h-10 rounded-full border border-primary/20">
                                <h4 class="font-bold text-sm">${p.uName}</h4>
                            </div>
                            <p class="text-slate-300 mb-4">${procesarTexto(p.content)}</p>
                            ${p.image ? `<img src="${p.image}" class="rounded-3xl w-full mb-4 border border-white/5 shadow-2xl">` : ""}
                            <div class="flex gap-6 border-t border-white/5 pt-4">
                                <button onclick="darLike('${p.id}')" class="flex items-center gap-2 ${hasLike ? 'text-accent' : 'text-slate-400'}">
                                    <span class="material-symbols-outlined ${hasLike ? 'fill-1' : ''}">favorite</span><span class="text-xs font-bold">${lCount}</span>
                                </button>
                                <button onclick="toggleComentarios('${p.id}')" class="flex items-center gap-2 text-slate-400">
                                    <span class="material-symbols-outlined">chat_bubble</span><span class="text-xs font-bold">Comentar</span>
                                </button>
                            </div>
                            <div id="box-com-${p.id}" class="hidden mt-4 bg-black/20 p-4 rounded-2xl">
                                <div id="lista-com-${p.id}" class="space-y-2 mb-3 max-h-32 overflow-y-auto custom-scrollbar"></div>
                                <div class="flex gap-2">
                                    <input id="in-com-${p.id}" type="text" class="flex-1 bg-white/5 border-none rounded-xl text-xs text-white" placeholder="Comentar...">
                                    <button onclick="enviarComentario('${p.id}')" class="bg-primary p-2 rounded-xl"><span class="material-symbols-outlined text-sm">send</span></button>
                                </div>
                            </div>
                        </div>`;
                });
            });
        }

        window.darLike = (id) => {
            const r = ref(db, `posts/${id}/likes/${userActual.uid}`);
            get(r).then(s => s.exists() ? remove(r) : set(r, true));
        };

        window.toggleComentarios = (id) => {
            const b = document.getElementById(`box-com-${id}`); b.classList.toggle('hidden');
            if(!b.classList.contains('hidden')) {
                onValue(ref(db, `posts/${id}/comentarios`), s => {
                    const l = document.getElementById(`lista-com-${id}`); l.innerHTML = "";
                    s.forEach(c => { l.innerHTML += `<div class="text-[10px] bg-white/5 p-2 rounded-lg text-slate-300"><b class="text-primary">${c.val().uName}:</b> ${c.val().texto}</div>`; });
                });
            }
        };

        window.enviarComentario = (id) => {
            const i = document.getElementById(`in-com-${id}`);
            if(!i.value.trim()) return;
            push(ref(db, `posts/${id}/comentarios`), { uName: userActual.displayName, texto: i.value });
            i.value = "";
        };

        // --- CHAT LÓGICA ---
        window.abrirChat = (uid, name, pic) => {
            chatDestinoUid = uid;
            document.getElementById('chat-header').innerHTML = `<img src="${pic}" class="w-8 h-8 rounded-full"> <span class="text-xs font-bold">${name}</span>`;
            const chatId = userActual.uid < uid ? `${userActual.uid}_${uid}` : `${uid}_${userActual.uid}`;
            
            onValue(ref(db, `chats/${chatId}`), snap => {
                const box = document.getElementById('chat-mensajes'); 
                box.innerHTML = "";
                snap.forEach(m => {
                    const mio = m.val().s === userActual.uid;
                    box.innerHTML += `<div class="max-w-[80%] ${mio ? 'self-end bg-primary shadow-lg shadow-primary/20' : 'self-start bg-white/10'} px-4 py-2 rounded-2xl text-[11px]">${m.val().t}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        document.getElementById('btn-send-chat').onclick = () => {
            const i = document.getElementById('chat-input');
            if(!chatDestinoUid || !i.value.trim()) return;
            const chatId = userActual.uid < chatDestinoUid ? `${userActual.uid}_${chatDestinoUid}` : `${chatDestinoUid}_${userActual.uid}`;
            push(ref(db, `chats/${chatId}`), { s: userActual.uid, t: i.value, time: serverTimestamp() });
            i.value = "";
        };

        // --- CONTACTOS ---
        async function cargarContactos() {
            if(!userActual) return;
            const list = document.getElementById('lista-contactos');
            onValue(ref(db, 'seguidores'), (snap) => {
                list.innerHTML = "";
                snap.forEach(perfil => {
                    if (perfil.hasChild(userActual.uid)) {
                        const contactUid = perfil.key;
                        get(ref(db, `online_users/${contactUid}`)).then(u => {
                            const d = u.exists() ? u.val() : { n: "Artista", p: "https://via.placeholder.com/100" };
                            list.innerHTML += `<div onclick="window.abrirChat('${contactUid}', '${d.n}', '${d.p}')" class="flex items-center gap-3 p-3 hover:bg-white/5 rounded-2xl cursor-pointer">
                                <img src="${d.p}" class="w-10 h-10 rounded-full border border-primary/20">
                                <span class="text-xs font-bold">${d.n}</span>
                            </div>`;
                        });
                    }
                });
            });
        }

        // --- NAVEGACIÓN ---
        window.showTab = (t) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('aside button').forEach(b => b.classList.remove('active-tab'));
            document.getElementById(`sec-${t}`).classList.remove('hidden');
            const b = document.getElementById(`tab-${t}`); if(b) b.classList.add('active-tab');
            if(t === 'mensajes') cargarContactos();
            if(t === 'explorar') cargarExplorar();
        };

        function escucharOnline() {
            onValue(ref(db, 'online_users'), snap => {
                const l = document.getElementById('online-list'); l.innerHTML = "";
                snap.forEach(u => {
                    l.innerHTML += `<div onclick="window.location.href='perfil.html?uid=${u.key}'" class="flex items-center gap-3 cursor-pointer">
                        <div class="relative"><img src="${u.val().p}" class="w-8 h-8 rounded-full border border-primary/20"><span class="absolute bottom-0 right-0 w-2 h-2 bg-green-500 rounded-full border border-background-dark"></span></div>
                        <span class="text-xs font-bold">${u.val().n}</span></div>`;
                });
            });
        }

        // NUEVA FUNCIÓN EXPLORAR EDITADA
        function cargarExplorar() {
            onValue(ref(db, 'posts'), snap => {
                const g = document.getElementById('explorar-grid'); 
                g.innerHTML = "";
                
                snap.forEach(p => { 
                    const post = p.val();
                    if(post.image) {
                        g.innerHTML += `
                            <div class="relative group overflow-hidden rounded-2xl border border-white/5 bg-black/20 aspect-square">
                                <img src="${post.image}" class="object-cover w-full h-full group-hover:scale-110 transition-transform duration-500">
                                
                                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent flex items-end p-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                    <div class="flex items-center gap-2 cursor-pointer w-full" onclick="window.location.href='perfil.html?uid=${post.uid}'">
                                        <img src="${post.uPic}" class="w-8 h-8 rounded-full border border-primary shadow-lg">
                                        <div class="flex flex-col min-w-0">
                                            <span class="text-[10px] font-bold text-white truncate">${post.uName}</span>
                                            <span class="text-[8px] text-primary font-black uppercase tracking-widest">Ver Perfil</span>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                    } 
                });
            });
        }

        window.irMiPerfil = () => window.location.href = `perfil.html?uid=${userActual.uid}`;
    </script>
</body>
</html>
