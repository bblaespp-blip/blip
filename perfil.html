<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - BLIP</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <style>
        :root { --primary: #7b2cbf; --accent: #ff0055; --bg: #050010; }
        body { background-color: var(--bg); color: white; font-family: 'Spline Sans', sans-serif; min-height: 100vh; margin: 0; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(123, 44, 191, 0.2); }
        .fill-1 { font-variation-settings: 'FILL' 1, 'wght' 400; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
        
        #noti-panel {
            display: none;
            position: absolute;
            right: 0;
            top: 70px;
            width: 320px;
            max-height: 450px;
            z-index: 100;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        .noti-item { border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.2s; background: rgba(255,255,255,0.02); margin-bottom: 4px; border-radius: 12px; }
        .noti-item:hover { background: rgba(123, 44, 191, 0.2); transform: translateX(-5px); }
    </style>
</head>
<body class="p-4 md:p-8 custom-scrollbar">

    <div class="max-w-4xl mx-auto relative">
        
        <div class="flex justify-between items-center mb-8">
            <a href="index.html" class="inline-flex items-center gap-2 text-slate-400 hover:text-white transition-all font-medium">
                <span class="material-symbols-outlined">arrow_back</span> Volver al Muro
            </a>

            <div class="relative">
                <button id="btn-noti" class="glass p-3 rounded-2xl text-slate-300 hover:text-primary transition-all relative">
                    <span class="material-symbols-outlined text-2xl">notifications</span>
                    <span id="noti-badge" class="hidden absolute -top-1 -right-1 bg-[#ff0055] text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-[#050010]">!</span>
                </button>

                <div id="noti-panel" class="glass rounded-[2rem] p-4 overflow-hidden flex flex-col border border-primary/30">
                    <h3 class="text-xs font-black p-2 mb-2 border-b border-white/10 italic uppercase tracking-widest text-primary">Avisos Recientes</h3>
                    <div id="noti-list" class="overflow-y-auto custom-scrollbar flex-1 flex flex-col gap-1 max-h-[350px]">
                        <p class="text-xs text-slate-500 text-center py-8 text-white">Cargando avisos...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass rounded-[3rem] p-8 mb-8 flex flex-col md:flex-row items-center gap-8 shadow-2xl relative">
            <div class="relative">
                <img id="perf-pic" src="https://via.placeholder.com/150" class="w-32 h-32 md:w-40 md:h-40 rounded-[2.5rem] border-4 border-primary object-cover shadow-2xl">
                <div id="status-dot" class="absolute bottom-2 right-2 w-6 h-6 bg-slate-500 border-4 border-[#050010] rounded-full"></div>
            </div>
            <div class="flex-1 text-center md:text-left">
                <h1 id="perf-name" class="text-4xl font-black tracking-tighter mb-2 italic uppercase">Cargando...</h1>
                <div class="flex justify-center md:justify-start gap-6 my-4 text-slate-300">
                    <span><b id="count-obras" class="text-white text-xl">0</b> Obras</span>
                    <span><b id="count-seguidores" class="text-white text-xl">0</b> Seguidores</span>
                </div>
                <div id="actions-container" class="flex flex-wrap justify-center md:justify-start gap-4 mt-4"></div>
            </div>
        </div>

        <div id="publish-area" class="hidden glass rounded-[2.5rem] p-6 mb-8 border-dashed border-primary/40">
            <textarea id="post-text" class="w-full bg-transparent border-none focus:ring-0 text-lg resize-none text-white placeholder:text-slate-600" placeholder="¿Qué vas a crear hoy?" rows="2"></textarea>
            <div id="preview-box" class="hidden mt-4"><img id="img-preview" class="rounded-3xl w-full max-h-80 object-cover border border-primary/20"></div>
            <div class="flex justify-between items-center mt-4 pt-4 border-t border-white/5">
                <label class="cursor-pointer text-primary hover:text-white transition-colors flex items-center gap-2">
                    <span class="material-symbols-outlined text-3xl">image</span>
                    <span class="text-xs font-bold uppercase text-white">Añadir Obra</span>
                    <input type="file" id="file-input" class="hidden" accept="image/*">
                </label>
                <button id="btn-post" class="bg-primary hover:bg-white hover:text-primary text-white px-10 py-2 rounded-2xl font-black transition-all shadow-lg shadow-primary/20 uppercase italic">BLIP!</button>
            </div>
        </div>

        <div id="perfil-feed" class="flex flex-col gap-6 pb-20"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
        import { getDatabase, ref, onValue, set, remove, get, push, serverTimestamp, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyA5yh8J7Mgij3iZCOEZ2N8r1yhDkLcXsTg", 
            authDomain: "almacenamiento-redsocial.firebaseapp.com", 
            databaseURL: "https://almacenamiento-redsocial-default-rtdb.firebaseio.com", 
            projectId: "almacenamiento-redsocial" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        const params = new URLSearchParams(window.location.search);
        const perfilUid = params.get('uid');
        let userActual = null;
        let selectedFile = null;
        let primeraCargaNoti = true;
        const sonidoNoti = new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_73147986c4.mp3');

        onAuthStateChanged(auth, user => {
            userActual = user;
            if(perfilUid) {
                cargarDatosPerfil();
                escucharSeguidores();
                cargarPostsUsuario();
                if(user) {
                    if(user.uid === perfilUid) document.getElementById('publish-area').classList.remove('hidden');
                    inicializarNotificaciones(user.uid);
                }
            }
        });

        // --- SISTEMA DE NOTIFICACIONES ---
        function enviarNoti(uidDestino, msj, extra = {}) {
            if (!userActual || uidDestino === userActual.uid) return;
            
            // Forzamos el nombre actual para que no se pierda
            const nombreRemitente = userActual.displayName || "Un usuario";
            
            push(ref(db, `notificaciones/${uidDestino}`), {
                u: nombreRemitente, 
                p: userActual.photoURL || "https://via.placeholder.com/100",
                m: msj,
                t: Date.now(),
                fromUid: userActual.uid,
                ...extra 
            });
        }

        function inicializarNotificaciones(uid) {
            const list = document.getElementById('noti-list');
            const badge = document.getElementById('noti-badge');
            
            onValue(query(ref(db, `notificaciones/${uid}`), limitToLast(15)), snap => {
                if (snap.exists()) {
                    if (!primeraCargaNoti) {
                        sonidoNoti.play().catch(() => {});
                        badge.classList.remove('hidden');
                    }
                    
                    list.innerHTML = "";
                    snap.forEach(n => {
                        const d = n.val();
                        
                        // Lógica de visualización: d.u es el nombre que guardamos en enviarNoti
                        const nombreParaMostrar = d.u && d.u !== "undefined" ? d.u : "Alguien";
                        const mensajeParaMostrar = d.m || "te envió una señal";
                        const fotoParaMostrar = d.p || "https://via.placeholder.com/100";
                        const tiempo = d.t ? new Date(d.t).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "Reciente";

                        const item = document.createElement('div');
                        item.className = "noti-item p-3 flex items-center gap-3 cursor-pointer";
                        item.innerHTML = `
                            <img src="${fotoParaMostrar}" class="w-10 h-10 rounded-full object-cover border border-primary/20 shadow-lg">
                            <div class="flex-1">
                                <p class="text-[12px] text-slate-200 leading-tight">
                                    <b class="text-white text-[13px]">${nombreParaMostrar}</b><br>
                                    ${mensajeParaMostrar}
                                </p>
                                <span class="text-[9px] text-primary font-bold uppercase tracking-tighter">${tiempo}</span>
                            </div>
                        `;
                        item.onclick = () => {
                            if(d.pid) window.location.href = `index.html?postId=${d.pid}`;
                            else window.location.href = `perfil.html?uid=${d.fromUid}`;
                        };
                        list.prepend(item);
                    });
                } else {
                    list.innerHTML = "<p class='text-[10px] text-slate-500 text-center py-8 uppercase tracking-widest text-white'>Sin avisos</p>";
                }
                primeraCargaNoti = false;
            });
        }

        // --- MANEJO DE INTERFAZ ---
        document.getElementById('btn-noti').onclick = (e) => {
            e.stopPropagation();
            const panel = document.getElementById('noti-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            document.getElementById('noti-badge').classList.add('hidden');
        };
        document.onclick = () => document.getElementById('noti-panel').style.display = 'none';

        function cargarDatosPerfil() {
            if (userActual && userActual.uid === perfilUid) {
                actualizarCabecera(userActual.displayName, userActual.photoURL, true);
                return;
            }
            onValue(ref(db, `online_users/${perfilUid}`), snap => {
                if(snap.exists()){
                    actualizarCabecera(snap.val().n, snap.val().p, true);
                } else {
                    get(ref(db, 'posts')).then(s => {
                        let hallado = false;
                        s.forEach(p => {
                            if(p.val().uid === perfilUid && !hallado){
                                actualizarCabecera(p.val().uName, p.val().uPic, false);
                                hallado = true;
                            }
                        });
                        if(!hallado) actualizarCabecera("Artista BLIP", "https://via.placeholder.com/150", false);
                    });
                }
            });
        }

        function actualizarCabecera(n, p, online) {
            document.getElementById('perf-name').innerText = n || "Cargando...";
            document.getElementById('perf-pic').src = p || "https://via.placeholder.com/150";
            document.getElementById('status-dot').className = `absolute bottom-2 right-2 w-6 h-6 border-4 border-[#050010] rounded-full ${online ? 'bg-green-500' : 'bg-slate-500'}`;
            renderBotones(); 
        }

        function renderBotones() {
            const container = document.getElementById('actions-container');
            if(!userActual || userActual.uid === perfilUid) { container.innerHTML = ""; return; }
            container.innerHTML = `
                <button id="btn-follow" class="bg-white text-black px-8 py-2 rounded-2xl font-black hover:bg-primary hover:text-white transition-all italic uppercase text-xs">SEGUIR</button>
                <button id="btn-chat" class="glass border border-white/10 px-8 py-2 rounded-2xl font-black hover:bg-white/10 transition-all italic uppercase text-xs">MENSAJE</button>
            `;
            onValue(ref(db, `seguidores/${perfilUid}/${userActual.uid}`), s => {
                const b = document.getElementById('btn-follow');
                if(!b) return;
                b.innerText = s.exists() ? "SIGUIENDO" : "SEGUIR";
                b.className = s.exists() ? "bg-primary text-white px-8 py-2 rounded-2xl font-black italic uppercase text-xs" : "bg-white text-black px-8 py-2 rounded-2xl font-black hover:bg-primary hover:text-white transition-all italic uppercase text-xs";
            });
            document.getElementById('btn-follow').onclick = () => {
                const r = ref(db, `seguidores/${perfilUid}/${userActual.uid}`);
                get(r).then(s => {
                    if(s.exists()) remove(r);
                    else {
                        set(r, { n: userActual.displayName, p: userActual.photoURL });
                        enviarNoti(perfilUid, "ha empezado a seguirte");
                    }
                });
            };
            document.getElementById('btn-chat').onclick = () => {
                localStorage.setItem('abrirChatCon', perfilUid);
                window.location.href = 'index.html'; 
            };
        }

        // --- FEED ---
        function cargarPostsUsuario() {
            onValue(ref(db, 'posts'), snap => {
                const feed = document.getElementById('perfil-feed');
                feed.innerHTML = "";
                let count = 0; let posts = [];
                snap.forEach(p => { if(p.val().uid === perfilUid) { posts.unshift({id: p.key, ...p.val()}); count++; } });
                posts.forEach(p => {
                    const hasLike = p.likes && userActual && p.likes[userActual.uid];
                    feed.innerHTML += `
                        <div class="glass rounded-[2.5rem] p-6 shadow-xl border-white/5">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center gap-3">
                                    <img src="${p.uPic}" class="w-10 h-10 rounded-full border border-primary/20">
                                    <h4 class="font-bold text-sm text-slate-200">${p.uName}</h4>
                                </div>
                                ${userActual && userActual.uid === p.uid ? `<button onclick="window.borrarPost('${p.id}')" class="text-slate-600 hover:text-accent"><span class="material-symbols-outlined">delete</span></button>` : ''}
                            </div>
                            <p class="text-slate-300 mb-4 text-sm">${p.content || ""}</p>
                            ${(p.image || p.url) ? `<img src="${p.image || p.url}" class="rounded-3xl w-full mb-4 border border-white/5 shadow-2xl">` : ""}
                            <div class="flex gap-6 border-t border-white/5 pt-4">
                                <button onclick="window.darLike('${p.id}', '${p.uid}')" class="flex items-center gap-2 ${hasLike ? 'text-[#ff0055]' : 'text-slate-400'}">
                                    <span class="material-symbols-outlined ${hasLike ? 'fill-1' : ''}">favorite</span>
                                    <span class="text-xs font-black">${p.likes ? Object.keys(p.likes).length : 0}</span>
                                </button>
                                <button onclick="window.toggleComentarios('${p.id}')" class="flex items-center gap-2 text-slate-400">
                                    <span class="material-symbols-outlined text-xl">chat_bubble</span>
                                    <span class="text-[10px] font-black uppercase">Comentar</span>
                                </button>
                            </div>
                            <div id="box-${p.id}" class="hidden mt-4 bg-black/20 p-4 rounded-3xl border border-white/5">
                                <div id="list-${p.id}" class="space-y-2 mb-3 max-h-32 overflow-y-auto custom-scrollbar text-xs"></div>
                                <div class="flex gap-2">
                                    <input id="in-${p.id}" type="text" class="flex-1 bg-white/5 border-none rounded-xl text-xs text-white" placeholder="Escribe algo...">
                                    <button onclick="window.enviarComentario('${p.id}', '${p.uid}')" class="bg-primary p-2 rounded-xl text-white"><span class="material-symbols-outlined text-sm">send</span></button>
                                </div>
                            </div>
                        </div>`;
                });
                document.getElementById('count-obras').innerText = count;
            });
        }

        window.darLike = (id, autorUid) => {
            const r = ref(db, `posts/${id}/likes/${userActual.uid}`);
            get(r).then(s => {
                if(s.exists()) remove(r);
                else { set(r, true); enviarNoti(autorUid, "le dio me gusta a tu obra", { pid: id }); }
            });
        };

        window.enviarComentario = (id, autorUid) => {
            const i = document.getElementById(`in-${id}`);
            if(!i.value.trim()) return;
            push(ref(db, `posts/${id}/comentarios`), { uName: userActual.displayName, texto: i.value });
            enviarNoti(autorUid, "comentó tu obra", { pid: id });
            i.value = "";
        };

        window.toggleComentarios = (id) => {
            const b = document.getElementById(`box-${id}`);
            b.classList.toggle('hidden');
            if(!b.classList.contains('hidden')) {
                onValue(ref(db, `posts/${id}/comentarios`), snap => {
                    const l = document.getElementById(`list-${id}`); l.innerHTML = "";
                    snap.forEach(c => { l.innerHTML += `<div class="p-1 text-white"><b class="text-primary">${c.val().uName}:</b> <span class="text-slate-300">${c.val().texto}</span></div>`; });
                });
            }
        };

        window.borrarPost = (id) => { if(confirm("¿Eliminar?")) remove(ref(db, `posts/${id}`)); };

        function escucharSeguidores() {
            onValue(ref(db, `seguidores/${perfilUid}`), snap => {
                let total = 0; snap.forEach(() => total++);
                document.getElementById('count-seguidores').innerText = total;
            });
        }

        document.getElementById('file-input').onchange = (e) => {
            selectedFile = e.target.files[0];
            if(selectedFile) {
                const reader = new FileReader();
                reader.onload = (f) => {
                    document.getElementById('img-preview').src = f.target.result;
                    document.getElementById('preview-box').classList.remove('hidden');
                };
                reader.readAsDataURL(selectedFile);
            }
        };

        document.getElementById('btn-post').onclick = async () => {
            const text = document.getElementById('post-text').value.trim();
            if(!text && !selectedFile) return;
            const btn = document.getElementById('btn-post');
            btn.innerText = "SUBIENDO..."; btn.disabled = true;
            let url = "";
            if(selectedFile) {
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('upload_preset', 'blip_unsigned');
                const res = await fetch('https://api.cloudinary.com/v1_1/dz9s37bk0/image/upload', { method: 'POST', body: formData });
                const data = await res.json();
                url = data.secure_url;
            }
            await push(ref(db, 'posts'), {
                uid: userActual.uid, uName: userActual.displayName, uPic: userActual.photoURL,
                content: text, image: url, timestamp: serverTimestamp()
            });
            document.getElementById('post-text').value = "";
            document.getElementById('preview-box').classList.add('hidden');
            selectedFile = null; btn.innerText = "BLIP!"; btn.disabled = false;
        };
    </script>
</body>
</html>
