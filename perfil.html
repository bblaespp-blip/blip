<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Perfil - BLIP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: { extend: { colors: { "primary": "#7b2cbf", "accent": "#ff0055", "background-dark": "#050010" } } }
        }
    </script>
    <style>
        body { background-color: #050010; color: white; font-family: 'Spline Sans', sans-serif; min-height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(123, 44, 191, 0.2); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #7b2cbf; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8 custom-scrollbar">

    <div class="max-w-4xl mx-auto flex justify-between items-center mb-10">
        <button onclick="window.location.href='index.html'" class="glass px-6 py-2 rounded-full flex items-center gap-2 hover:bg-white/10 transition-all text-sm">
            <span class="material-symbols-outlined">arrow_back</span> Volver al Muro
        </button>
        <span class="text-xl font-black italic text-primary uppercase tracking-tighter">BLIP</span>
    </div>

    <main class="max-w-4xl mx-auto space-y-8">
        
        <div class="glass rounded-[3rem] p-8 md:p-12 relative overflow-hidden">
            <div class="flex flex-col md:flex-row items-center gap-8 relative z-10">
                <div class="relative">
                    <img id="user-avatar" src="https://via.placeholder.com/150" class="w-32 h-32 md:w-44 md:h-44 rounded-[2.5rem] object-cover border-4 border-primary/30 shadow-2xl shadow-primary/20">
                    <div id="status-dot" class="absolute bottom-2 right-2 w-6 h-6 bg-slate-500 border-4 border-background-dark rounded-full"></div>
                </div>

                <div class="flex-1 text-center md:text-left space-y-4">
                    <h1 id="user-name" class="text-4xl md:text-6xl font-black tracking-tighter italic uppercase">CARGANDO...</h1>
                    
                    <div class="flex flex-wrap justify-center md:justify-start gap-6 text-sm font-medium text-slate-400">
                        <div class="flex flex-col"><span id="count-obras" class="text-white text-xl font-bold">0</span> <span class="text-[10px] uppercase tracking-widest">Obras</span></div>
                        <div class="flex flex-col"><span id="count-seguidores" class="text-white text-xl font-bold">0</span> <span class="text-[10px] uppercase tracking-widest">Seguidores</span></div>
                    </div>

                    <div id="actions" class="flex flex-wrap justify-center md:justify-start gap-3 pt-4">
                        <button id="btn-seguir" onclick="toggleSeguir()" class="bg-white text-black px-8 py-3 rounded-2xl font-black text-xs uppercase tracking-widest hover:scale-105 transition-transform">Seguir</button>
                        <button id="btn-mensaje" onclick="irAlChat()" class="glass px-8 py-3 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-white/10 transition-all">Mensaje</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <h3 class="text-xs font-bold text-primary uppercase tracking-[0.3em] pl-4">Colección de Blips</h3>
            <div id="user-feed" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, get, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA5yh8J7Mgij3iZCOEZ2N8r1yhDkLcXsTg",
            authDomain: "almacenamiento-redsocial.firebaseapp.com",
            databaseURL: "https://almacenamiento-redsocial-default-rtdb.firebaseio.com",
            projectId: "almacenamiento-redsocial"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const urlParams = new URLSearchParams(window.location.search);
        const perfilUid = urlParams.get('uid');
        let userActual = null;
        let nombreParaChat = "";
        let fotoParaChat = "";

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userActual = user;
                if (user.uid === perfilUid) {
                    document.getElementById('actions').innerHTML = `<button onclick="window.location.href='index.html'" class="bg-primary/20 text-primary border border-primary/50 px-8 py-3 rounded-2xl font-black text-xs uppercase tracking-widest">Mi Perfil</button>`;
                }
                checarSiSigo();
            }
            cargarPerfil();
            cargarPostsUsuario();
            contarSeguidores();
        });

        // --- SISTEMA DE NOTIFICACIONES ---
        function enviarNotificacion(destinoUid, mensaje) {
            if (!userActual || destinoUid === userActual.uid) return;
            push(ref(db, `notificaciones/${destinoUid}`), {
                fromName: userActual.displayName,
                fromPic: userActual.photoURL,
                texto: mensaje,
                visto: false,
                time: serverTimestamp()
            });
        }

        // --- CARGA DE DATOS CON RESPALDO (FIX "CARGANDO") ---
        function cargarPerfil() {
            // Intentar primero en usuarios online
            onValue(ref(db, `online_users/${perfilUid}`), (snap) => {
                if (snap.exists()) {
                    actualizarUI(snap.val().n, snap.val().p, true);
                } else {
                    // Si no está online, buscar en el historial de posts
                    get(ref(db, 'posts')).then(postsSnap => {
                        let hallado = false;
                        postsSnap.forEach(p => {
                            if (p.val().uid === perfilUid && !hallado) {
                                actualizarUI(p.val().uName, p.val().uPic, false);
                                hallado = true;
                            }
                        });
                        if (!hallado) actualizarUI("Usuario de BLIP", "https://via.placeholder.com/150", false);
                    });
                }
            });
        }

        function actualizarUI(nombre, foto, online) {
            document.getElementById('user-name').innerText = nombre;
            document.getElementById('user-avatar').src = foto;
            document.getElementById('status-dot').className = `absolute bottom-2 right-2 w-6 h-6 border-4 border-background-dark rounded-full ${online ? 'bg-green-500' : 'bg-slate-600'}`;
            nombreParaChat = nombre;
            fotoParaChat = foto;
        }

        function cargarPostsUsuario() {
            onValue(ref(db, 'posts'), (snap) => {
                const container = document.getElementById('user-feed');
                container.innerHTML = "";
                let count = 0;
                snap.forEach(p => {
                    if (p.val().uid === perfilUid) {
                        count++;
                        const post = p.val();
                        container.innerHTML += `
                            <div class="glass rounded-[2rem] overflow-hidden">
                                ${post.image ? `<img src="${post.image}" class="w-full h-64 object-cover border-b border-white/5">` : ''}
                                <div class="p-6">
                                    <p class="text-slate-300 text-sm italic">"${post.content || 'Sin descripción'}"</p>
                                </div>
                            </div>`;
                    }
                });
                document.getElementById('count-obras').innerText = count;
            });
        }

        // --- LÓGICA DE SEGUIMIENTO ---
        window.toggleSeguir = () => {
            if(!userActual) return alert("Inicia sesión para seguir");
            const r = ref(db, `seguidores/${perfilUid}/${userActual.uid}`);
            get(r).then(s => {
                if (s.exists()) {
                    remove(r);
                } else {
                    set(r, true);
                    enviarNotificacion(perfilUid, "empezó a seguirte");
                }
            });
        };

        function checarSiSigo() {
            if(!userActual) return;
            onValue(ref(db, `seguidores/${perfilUid}/${userActual.uid}`), snap => {
                const btn = document.getElementById('btn-seguir');
                if (btn) {
                    if (snap.exists()) {
                        btn.innerText = "SIGUIENDO";
                        btn.classList.replace('bg-white', 'bg-primary');
                        btn.classList.replace('text-black', 'text-white');
                    } else {
                        btn.innerText = "SEGUIR";
                        btn.classList.replace('bg-primary', 'bg-white');
                        btn.classList.replace('text-white', 'text-black');
                    }
                }
            });
        }

        function contarSeguidores() {
            onValue(ref(db, `seguidores/${perfilUid}`), snap => {
                document.getElementById('count-seguidores').innerText = snap.exists() ? Object.keys(snap.val()).length : 0;
            });
        }

        window.irAlChat = () => {
            localStorage.setItem('abrirChatCon', perfilUid);
            localStorage.setItem('nombreChatCon', nombreParaChat);
            localStorage.setItem('fotoChatCon', fotoParaChat);
            window.location.href = 'index.html';
        };
    </script>
</body>
</html>
